<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FootyLive</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/icons/foop.png">
</head>

<body>
    <h1 id="fixtureHeader" style="text-align: center;">This Week's Fixtures</h1>
    <button id="darkModeToggle"><i class="fa-solid fa-star-half-stroke"></i></button>
    <button id="backToTop"><i class="fa-solid fa-up-long"></i></button>
    <div id="fixture-data">
        <!-- Fixture data will be displayed here -->
    </div>
    <br>
    <hr>
    <ul id="round-list">
        <li data-round="1">1</li>
        <li data-round="2">2</li>
        <li data-round="3">3</li>
        <li data-round="4">4</li>
        <li data-round="5">5</li>
        <li data-round="6">6</li>
        <li data-round="7">7</li>
        <li data-round="8">8</li>
        <li data-round="9">9</li>
        <li data-round="10">10</li>
        <li data-round="11">11</li>
        <li data-round="12">12</li>
        <li data-round="13">13</li>
        <li data-round="14">14</li>
        <li data-round="15">15</li>
        <li data-round="16">16</li>
        <li data-round="17">17</li>
        <li data-round="18">18</li>
        <li data-round="19">19</li>
        <li data-round="20">20</li>
        <li data-round="21">21</li>
        <li data-round="22">22</li>
        <li data-round="23">23</li>
        <li data-round="24">24</li>
    </ul>
    <div id="fixtures-list"></div>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            const listItems = document.getElementsByTagName("li");

            for (let i = 0; i < listItems.length; i++) {
                listItems[i].addEventListener("click", (event) => {
                    const round = event.target.getAttribute("data-round");
                    // scroll into view
                    try {
                        document.getElementById(`round-${round}`).scrollIntoView({ behavior: 'smooth' });
                    } catch {
                        alert("Round hasn't occured yet!")
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            const backToTop = document.getElementById("backToTop");
            backToTop.addEventListener("click", (event) => {
                const fixtureHeader = document.getElementById("fixtureHeader");
                // scroll into view
                fixtureHeader.scrollIntoView({ behavior: 'smooth' });
            });
        });

        // Function to fetch fixture data from the server
        function fetchFixtureData() {
            return fetch('/fixture-data')
                .then(response => response.json())
                .catch(error => {
                    console.error('Error fetching fixture data:', error);
                    throw error; // Propagate the error
                });
        }

        async function fetchPreviousFixtures() {
            try {
                const response = await fetch('/previous-fixtures');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const fixtureData = await response.json();
                displayPreviousFixtures(fixtureData);
            } catch (error) {
                console.error('Error fetching previous fixtures:', error);
            }
        }

        function displayPreviousFixtures(fixtureData) {
            const fixturesList = document.getElementById('fixtures-list');
            fixturesList.innerHTML = ''; // Clear any existing data

            // Step 1: Group fixtures by round
            const fixturesByRound = fixtureData.reduce((acc, fixture) => {
                let playerWithTeam0 = fixture.players.find(player => player.team === 0);
                let playerWithTeam1 = fixture.players.find(player => player.team === 1);

                if (playerWithTeam0 && playerWithTeam1) {
                    const round = playerWithTeam0.round; // Example: "Round 11"
                    if (!acc[round]) {
                        acc[round] = [];
                    }
                    acc[round].push({
                        team0: playerWithTeam0.teamName,
                        team1: playerWithTeam1.teamName,
                        date: playerWithTeam0.date,
                        link: playerWithTeam0.trimmedLink
                    });
                }
                return acc;
            }, {});

            // Step 2: Extract and sort rounds in descending order and remove the latest round
            const sortedRounds = Object.keys(fixturesByRound)
                .map(roundStr => ({
                    roundStr,
                    roundNum: parseInt(roundStr.replace('Round ', ''))
                })) // Extract the round number
                .sort((a, b) => b.roundNum - a.roundNum); // Sort in descending order

            // Remove the latest round
            sortedRounds.shift();

            // Step 3: Create list items for each round
            sortedRounds.forEach(({ roundStr }) => {
                const roundHeader = document.createElement('h2');
                roundHeader.textContent = `${roundStr}:`;
                roundHeader.id = `round-${roundStr.split(' ')[1]}`;
                fixturesList.appendChild(roundHeader);

                const fixtureContainer = document.createElement('div');
                fixtureContainer.classList.add('fixtureContainer');

                const roundFixtures = fixturesByRound[roundStr];
                roundFixtures.forEach(fixture => {
                    const listItem = document.createElement('a');
                    listItem.href = `/fixture/${fixture.link}`;
                    listItem.innerHTML = `
                <div class="team homeTeamContainer">
                    <img id="homeTeamIcon" src="/svg/${fixture.team0.replace(/\s+/g, '')}.svg" alt="Home Team Logo">
                </div>
                <div class="previousGameInfo">
                    <p>${fixture.team0} vs ${fixture.team1}</p>
                    <br>
                    <p id="gameLocation">${fixture.date}</p>
                </div>
                <div class="team awayTeamContainer">
                    <img id="awayTeamIcon" src="/svg/${fixture.team1.replace(/\s+/g, '')}.svg" alt="Away Team Logo">
                </div>
            `;
                    fixtureContainer.appendChild(listItem); // Append the list item to the fixtureContainer
                });

                fixturesList.appendChild(fixtureContainer); // Append the fixtureContainer to fixturesList
            });
        }



        // Call the function to fetch and display previous fixtures on page load
        document.addEventListener('DOMContentLoaded', fetchPreviousFixtures);

        // Function to format and display fixture data
        function displayFixtureData() {
            const fixtureDataContainer = document.getElementById('fixture-data');
            fixtureDataContainer.innerHTML = ''; // Clear previous data

            fetchFixtureData()
                .then(data => {
                    // Iterate over each fixture and create HTML elements to display them
                    data.games.forEach(fixture => {

                        const localLink = fixture.link.split("/").pop();

                        const fixtureElement = document.createElement('a');
                        fixtureElement.href = '/';
                        fixtureElement.classList.add('fixtureScoreboard');

                        fixtureElement.addEventListener('click', function (event) {
                            event.preventDefault();
                            //console.log("FIXTURE LINK: ", fixture.link);
                            fetch('/game-link', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    link: fixture.link
                                })
                            }).then(response => {
                                if (response.ok) {
                                    window.location.href = `/fixture/${localLink}`;
                                } else {
                                    console.error('Error setting game link:', response.status);
                                }
                            }).catch(error => {
                                console.error('Error setting game link:', error);
                            });
                        });

                        let winning = "";
                        const highestScore = Math.max(fixture.team0score, fixture.team1score);
                        const lowestScore = Math.min(fixture.team0score, fixture.team1score);
                        const margin = highestScore - lowestScore;
                        const team0NameForIcon = fixture.team0.replace(/\s/g, '');
                        const team1NameForIcon = fixture.team1.replace(/\s/g, '');

                        if (fixture.team0score == highestScore) {
                            winning = `${fixture.team0} <br>by ${margin}`;
                        }
                        else {
                            winning = `${fixture.team1} <br>by ${margin}`;
                        }

                        if (fixture.team0score == fixture.team1score) {
                            if (highestScore == 0) {
                                winning = "TBD";
                            } else {
                                winning = "Draw";
                            }
                        }

                        fixtureElement.innerHTML = `
                            
                            <div class="team homeTeamContainer">
                                <h2 class="hide-on-mobile">${fixture.team0}</h2>
                                <img id="homeTeamIcon" src="/svg/${team0NameForIcon}.svg" alt="Home Team Logo">
                                <h2 id="homeTeamScore">${fixture.team0score}</h2>
                            </div>
                            <div class="gameInfo">
                                <h2 id="currentPeriod">${fixture.time}</h2>
                                <p id="margin">${winning}</p>
                                <br>
                                <p id="gameLocation">${fixture.location}</p>
                            </div>
                            <div class="team awayTeamContainer">
                                <h2 id="awayTeamScore">${fixture.team1score}</h2>
                                <img id="awayTeamIcon" src="/svg/${team1NameForIcon}.svg" alt="Away Team Logo">
                                <h2 class="hide-on-mobile">${fixture.team1}</h2>
                            </div>
                     
                        `;

                        fixtureDataContainer.appendChild(fixtureElement);

                        let fixtureScoreboards = document.getElementsByClassName('fixtureScoreboard');
                        if (fixture.time == 'FULL TIME') {
                            fixtureElement.style.borderTop = '8px red solid';
                        } else if (fixture.time.includes("Q")) {
                            fixtureElement.style.borderTop = '8px green solid';
                        }
                    });
                })
                .catch(error => {
                    // Handle errors, e.g., display an error message
                    fixtureDataContainer.innerHTML = '<p>Error fetching fixture data. Please try again later.</p>';
                    throw error; // Propagate the error
                });
        }

        // Function to fetch and display fixture data initially upon page load
        displayFixtureData();

        // Function to fetch and display fixture data every 10 seconds
        setInterval(displayFixtureData, 60000);

        document.getElementById('darkModeToggle').addEventListener('click', function () {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');

            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        });

    </script>
    <script src="https://kit.fontawesome.com/0bb575a0ce.js" crossorigin="anonymous"></script>
</body>

</html>